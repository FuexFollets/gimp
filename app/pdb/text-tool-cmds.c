/* LIGMA - The GNU Image Manipulation Program
 * Copyright (C) 1995-2003 Spencer Kimball and Peter Mattis
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

/* NOTE: This file is auto-generated by pdbgen.pl. */

#include "config.h"

#include "stamp-pdbgen.h"

#include <gegl.h>

#include <gdk-pixbuf/gdk-pixbuf.h>

#include "libligmabase/ligmabase.h"

#include "libligmabase/ligmabase.h"

#include "pdb-types.h"

#include "core/ligmadrawable.h"
#include "core/ligmaimage.h"
#include "core/ligmalayer.h"
#include "core/ligmaparamspecs.h"
#include "text/ligmatext-compat.h"

#include "ligmapdb.h"
#include "ligmapdb-utils.h"
#include "ligmaprocedure.h"
#include "internal-procs.h"


static LigmaValueArray *
text_fontname_invoker (LigmaProcedure         *procedure,
                       Ligma                  *ligma,
                       LigmaContext           *context,
                       LigmaProgress          *progress,
                       const LigmaValueArray  *args,
                       GError               **error)
{
  gboolean success = TRUE;
  LigmaValueArray *return_vals;
  LigmaImage *image;
  LigmaDrawable *drawable;
  gdouble x;
  gdouble y;
  const gchar *text;
  gint border;
  gboolean antialias;
  gdouble size;
  const gchar *fontname;
  LigmaLayer *text_layer = NULL;

  image = g_value_get_object (ligma_value_array_index (args, 0));
  drawable = g_value_get_object (ligma_value_array_index (args, 1));
  x = g_value_get_double (ligma_value_array_index (args, 2));
  y = g_value_get_double (ligma_value_array_index (args, 3));
  text = g_value_get_string (ligma_value_array_index (args, 4));
  border = g_value_get_int (ligma_value_array_index (args, 5));
  antialias = g_value_get_boolean (ligma_value_array_index (args, 6));
  size = g_value_get_double (ligma_value_array_index (args, 7));
  fontname = g_value_get_string (ligma_value_array_index (args, 9));

  if (success)
    {
      if (drawable &&
          (! ligma_pdb_item_is_attached (LIGMA_ITEM (drawable), image,
                                        LIGMA_PDB_ITEM_CONTENT, error) ||
           ! ligma_pdb_item_is_not_group (LIGMA_ITEM (drawable), error)))
        success = FALSE;

      if (success)
        {
          gchar *real_fontname = g_strdup_printf ("%s %d", fontname, (gint) size);

          text_layer = text_render (image, drawable, context,
                                    x, y, real_fontname, text,
                                    border, antialias);

          g_free (real_fontname);
        }
    }

  return_vals = ligma_procedure_get_return_values (procedure, success,
                                                  error ? *error : NULL);

  if (success)
    g_value_set_object (ligma_value_array_index (return_vals, 1), text_layer);

  return return_vals;
}

static LigmaValueArray *
text_get_extents_fontname_invoker (LigmaProcedure         *procedure,
                                   Ligma                  *ligma,
                                   LigmaContext           *context,
                                   LigmaProgress          *progress,
                                   const LigmaValueArray  *args,
                                   GError               **error)
{
  gboolean success = TRUE;
  LigmaValueArray *return_vals;
  const gchar *text;
  gdouble size;
  const gchar *fontname;
  gint width = 0;
  gint height = 0;
  gint ascent = 0;
  gint descent = 0;

  text = g_value_get_string (ligma_value_array_index (args, 0));
  size = g_value_get_double (ligma_value_array_index (args, 1));
  fontname = g_value_get_string (ligma_value_array_index (args, 3));

  if (success)
    {
      gchar *real_fontname = g_strdup_printf ("%s %d", fontname, (gint) size);

      success = text_get_extents (ligma,
                                  real_fontname, text,
                                  &width, &height,
                                  &ascent, &descent);

      g_free (real_fontname);
    }

  return_vals = ligma_procedure_get_return_values (procedure, success,
                                                  error ? *error : NULL);

  if (success)
    {
      g_value_set_int (ligma_value_array_index (return_vals, 1), width);
      g_value_set_int (ligma_value_array_index (return_vals, 2), height);
      g_value_set_int (ligma_value_array_index (return_vals, 3), ascent);
      g_value_set_int (ligma_value_array_index (return_vals, 4), descent);
    }

  return return_vals;
}

void
register_text_tool_procs (LigmaPDB *pdb)
{
  LigmaProcedure *procedure;

  /*
   * ligma-text-fontname
   */
  procedure = ligma_procedure_new (text_fontname_invoker);
  ligma_object_set_static_name (LIGMA_OBJECT (procedure),
                               "ligma-text-fontname");
  ligma_procedure_set_static_help (procedure,
                                  "Add text at the specified location as a floating selection or a new layer.",
                                  "This tool requires a fontname matching an installed PangoFT2 font. You can specify the fontsize in units of pixels or points, and the appropriate metric is specified using the size_type argument. The x and y parameters together control the placement of the new text by specifying the upper left corner of the text bounding box. If the specified drawable parameter is valid, the text will be created as a floating selection attached to the drawable. If the drawable parameter is not valid (%NULL), the text will appear as a new layer. Finally, a border can be specified around the final rendered text. The border is measured in pixels. Parameter size-type is not used and is currently ignored. If you need to display a font in points, divide the size in points by 72.0 and multiply it by the image's vertical resolution.",
                                  NULL);
  ligma_procedure_set_static_attribution (procedure,
                                         "Martin Edlman & Sven Neumann",
                                         "Spencer Kimball & Peter Mattis",
                                         "1998- 2001");
  ligma_procedure_add_argument (procedure,
                               ligma_param_spec_image ("image",
                                                      "image",
                                                      "The image",
                                                      FALSE,
                                                      LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               ligma_param_spec_drawable ("drawable",
                                                         "drawable",
                                                         "The affected drawable: (%NULL for a new text layer)",
                                                         TRUE,
                                                         LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_double ("x",
                                                    "x",
                                                    "The x coordinate for the left of the text bounding box",
                                                    -G_MAXDOUBLE, G_MAXDOUBLE, 0,
                                                    LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_double ("y",
                                                    "y",
                                                    "The y coordinate for the top of the text bounding box",
                                                    -G_MAXDOUBLE, G_MAXDOUBLE, 0,
                                                    LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               ligma_param_spec_string ("text",
                                                       "text",
                                                       "The text to generate (in UTF-8 encoding)",
                                                       FALSE, FALSE, FALSE,
                                                       NULL,
                                                       LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_int ("border",
                                                 "border",
                                                 "The size of the border",
                                                 -1, G_MAXINT32, -1,
                                                 LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_boolean ("antialias",
                                                     "antialias",
                                                     "Antialiasing",
                                                     FALSE,
                                                     LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_double ("size",
                                                    "size",
                                                    "The size of text in either pixels or points",
                                                    0, G_MAXDOUBLE, 0,
                                                    LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_enum ("size-type",
                                                  "size type",
                                                  "The units of specified size",
                                                  LIGMA_TYPE_SIZE_TYPE,
                                                  LIGMA_PIXELS,
                                                  LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               ligma_param_spec_string ("fontname",
                                                       "fontname",
                                                       "The name of the font",
                                                       FALSE, FALSE, FALSE,
                                                       NULL,
                                                       LIGMA_PARAM_READWRITE));
  ligma_procedure_add_return_value (procedure,
                                   ligma_param_spec_layer ("text-layer",
                                                          "text layer",
                                                          "The new text layer or %NULL if no layer was created.",
                                                          TRUE,
                                                          LIGMA_PARAM_READWRITE));
  ligma_pdb_register_procedure (pdb, procedure);
  g_object_unref (procedure);

  /*
   * ligma-text-get-extents-fontname
   */
  procedure = ligma_procedure_new (text_get_extents_fontname_invoker);
  ligma_object_set_static_name (LIGMA_OBJECT (procedure),
                               "ligma-text-get-extents-fontname");
  ligma_procedure_set_static_help (procedure,
                                  "Get extents of the bounding box for the specified text.",
                                  "This tool returns the width and height of a bounding box for the specified text string with the specified font information. Ascent and descent for the specified font are returned as well. Parameter size-type is not used and is currently ignored. If you need to display a font in points, divide the size in points by 72.0 and multiply it by the vertical resolution of the image you are taking into account.",
                                  NULL);
  ligma_procedure_set_static_attribution (procedure,
                                         "Martin Edlman & Sven Neumann",
                                         "Spencer Kimball & Peter Mattis",
                                         "1998- 2001");
  ligma_procedure_add_argument (procedure,
                               ligma_param_spec_string ("text",
                                                       "text",
                                                       "The text to generate (in UTF-8 encoding)",
                                                       FALSE, FALSE, FALSE,
                                                       NULL,
                                                       LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_double ("size",
                                                    "size",
                                                    "The size of text in either pixels or points",
                                                    0, G_MAXDOUBLE, 0,
                                                    LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               g_param_spec_enum ("size-type",
                                                  "size type",
                                                  "The units of specified size",
                                                  LIGMA_TYPE_SIZE_TYPE,
                                                  LIGMA_PIXELS,
                                                  LIGMA_PARAM_READWRITE));
  ligma_procedure_add_argument (procedure,
                               ligma_param_spec_string ("fontname",
                                                       "fontname",
                                                       "The name of the font",
                                                       FALSE, FALSE, FALSE,
                                                       NULL,
                                                       LIGMA_PARAM_READWRITE));
  ligma_procedure_add_return_value (procedure,
                                   g_param_spec_int ("width",
                                                     "width",
                                                     "The width of the specified font",
                                                     G_MININT32, G_MAXINT32, 0,
                                                     LIGMA_PARAM_READWRITE));
  ligma_procedure_add_return_value (procedure,
                                   g_param_spec_int ("height",
                                                     "height",
                                                     "The height of the specified font",
                                                     G_MININT32, G_MAXINT32, 0,
                                                     LIGMA_PARAM_READWRITE));
  ligma_procedure_add_return_value (procedure,
                                   g_param_spec_int ("ascent",
                                                     "ascent",
                                                     "The ascent of the specified font",
                                                     G_MININT32, G_MAXINT32, 0,
                                                     LIGMA_PARAM_READWRITE));
  ligma_procedure_add_return_value (procedure,
                                   g_param_spec_int ("descent",
                                                     "descent",
                                                     "The descent of the specified font",
                                                     G_MININT32, G_MAXINT32, 0,
                                                     LIGMA_PARAM_READWRITE));
  ligma_pdb_register_procedure (pdb, procedure);
  g_object_unref (procedure);
}
